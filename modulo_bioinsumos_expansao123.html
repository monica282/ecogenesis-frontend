
<!DOCTYPE html>

<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Módulo de Bioinsumos – Ecogenesis Lab</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script> <!-- TensorFlow.js para IA -->
<style>
    body {
      background-color: #e3f2e9;
    }
    .text-main {
      color: #14532d;
    }
    .hover-main:hover {
      background-color: #14532d;
    }
  </style>
</head>
<body class="bg-main min-h-screen font-sans flex flex-col items-center">
<!-- Cabeçalho -->
<header class="w-full bg-white py-4 shadow-sm border-b border-gray-200 text-center">
<img alt="Logo Ecogenesis Lab" class="h-36 mx-auto mb-2" src="logo_ecogenesis.png"/>
<h1 class="text-2xl font-bold text-main">Ecogenesis Lab</h1>
<p class="text-sm text-gray-500">Plataforma de Bioinsumos Inteligentes</p>
</header>
<!-- Formulário do Módulo de Bioinsumos -->
<main class="w-full max-w-2xl bg-white mt-8 p-6 rounded-lg shadow-md">
<div class="bg-yellow-100 text-yellow-900 text-sm text-center p-2 mb-4 rounded">
      ⚠️ Complete os campos para cadastro e recomendações de bioinsumos.
    </div>
<form class="space-y-4" id="bioinsumo-form">
<input class="w-full px-3 py-2 border rounded" id="diagnostico" placeholder="Diagnóstico Agronômico" required="" type="text"/>
<!-- Campos de Bioinsumo -->
<input class="w-full px-3 py-2 border rounded" id="tipo-bioinsumo" placeholder="Tipo de Bioinsumo (ex: Fungicida, Biofertilizante)" type="text"/>
<input class="w-full px-3 py-2 border rounded" id="funcao-bioinsumo" placeholder="Função do Bioinsumo" type="text"/>
<input class="w-full px-3 py-2 border rounded" id="aplicacao-bioinsumo" placeholder="Aplicação do Bioinsumo" type="text"/>
<!-- Campos dinâmicos visíveis para o tipo 'fertilizante' -->
<div id="fields-dinamicos">
<input class="w-full px-3 py-2 border rounded mt-2" placeholder="Composição do Fertilizante" type="text"/>
</div>
<!-- Campos de Resíduo -->
<input class="w-full px-3 py-2 border rounded" id="tipo-residuo" placeholder="Tipo de Resíduo Utilizado" type="text"/>
<input class="w-full px-3 py-2 border rounded" id="volume-residuo" placeholder="Volume de Resíduo (kg ou L)" type="number"/>
<input class="w-full px-3 py-2 border rounded" id="origem-residuo" placeholder="Origem do Resíduo" type="text"/>
<!-- Envio para Análise Laboratorial -->
<section id="analise-laboratorial">
<h2>Envio para análise laboratorial (se necessário)</h2>
<button class="bg-green-700 text-white px-4 py-2 rounded w-full" id="enviar-analise" type="button">Enviar para Análise</button>
</section>
<!-- Recomendação Automática -->
<textarea class="w-full px-3 py-2 border rounded" id="recomendacoes" placeholder="Recomendações e Protocolos Automáticos">Com base nas condições da sua propriedade, recomendamos o uso de bioinsumos com ação fungicida e aumento de nutrientes no solo.</textarea>
<textarea class="w-full px-3 py-2 border rounded" id="feedback" placeholder="Feedback do Produtor"></textarea>
<button class="bg-green-700 text-white px-4 py-2 rounded w-full" type="submit">Salvar Bioinsumo</button>
</form>
<!-- Status separado para os dois botões -->
<div class="mt-4 text-sm bg-yellow-100 p-4 rounded font-mono whitespace-pre-wrap text-center" id="status-salvar"></div>
<div class="mt-4 text-sm bg-yellow-100 p-4 rounded font-mono whitespace-pre-wrap text-center" id="status-analise"></div>
<!-- Exibição de insights gerados pela IA -->
<div class="mt-4 text-sm bg-green-100 p-4 rounded font-mono text-center" id="insights">
<p><strong>Insight IA:</strong> Recomendação de bioinsumo gerada com base nos dados inseridos.</p>
</div>

<div class="mt-8 bg-white p-4 rounded shadow-sm">
<h2 class="text-lg font-semibold text-main mb-2">Filtrar Histórico</h2>
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
<input class="px-3 py-2 border rounded" id="filtro-tipo" placeholder="Tipo de Bioinsumo" type="text"/>
<input class="px-3 py-2 border rounded" id="filtro-diagnostico" placeholder="Diagnóstico" type="text"/>
<input class="px-3 py-2 border rounded" id="filtro-periodo" type="date"/>
</div>
<button class="mt-4 bg-green-800 text-white px-4 py-2 rounded" onclick="aplicarFiltros()">Aplicar Filtros</button>
</div>
<div class="mt-10 p-4 bg-gray-100 rounded text-sm" id="historico"></div>
<div class="mt-10">
<h2 class="text-lg font-semibold text-main mb-2">Gráfico de Volume por Tipo</h2>
<canvas id="graficoVolume"></canvas>
</div>
<button class="mt-4 bg-green-800 text-white px-4 py-2 rounded" id="btn-exportar">Exportar Histórico (CSV)</button></main>
<footer class="mt-12 text-center text-sm text-gray-500 py-6">
    © 2025 Ecogenesis Lab · Deep Tech Lab · Todos os direitos reservados.
  </footer>
<script>
    // Configuração do Supabase
    const supabase = window.supabase.createClient(
      "https://qojbgtzjwehdblcnjhvn.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvamJndHpqd2VoZGJsY25qaHZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxMjU0NTYsImV4cCI6MjA2MzcwMTQ1Nn0.WT7wI0HMkz40v570-lRDO-G8axgSynhkMlloT6TicOI"
    );

    const form = document.getElementById("bioinsumo-form");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Verificando se o usuário está logado corretamente
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      if (sessionError || !session) {
        document.getElementById("status-salvar").innerText = "⚠️ Nenhuma sessão ativa. Faça login.";
        return;
      }

      const userId = session.user.id;

      // Validando os campos do formulário antes de enviar
      const volume_residuo = document.getElementById("volume-residuo").value.trim() === "" ? null : parseFloat(document.getElementById("volume-residuo").value);

      const dados = {
        usuario_id: userId,
        diagnostico: document.getElementById("diagnostico").value.trim(),
        tipo_bioinsumo: document.getElementById("tipo-bioinsumo").value.trim(),
        funcao_bioinsumo: document.getElementById("funcao-bioinsumo").value.trim(),
        aplicacao_bioinsumo: document.getElementById("aplicacao-bioinsumo").value.trim(),
        tipo_residuo: document.getElementById("tipo-residuo").value.trim(),
        volume_residuo: volume_residuo,  // Garantindo que o volume_residuo não seja undefined ou vazio
        origem_residuo: document.getElementById("origem-residuo").value.trim(),
        recomendacoes: document.getElementById("recomendacoes").value.trim(),
        feedback: document.getElementById("feedback").value.trim()
      };

      // Verificando se algum campo essencial está vazio ou undefined
      if (!dados.diagnostico || !dados.tipo_bioinsumo || !dados.tipo_residuo || dados.volume_residuo === undefined) {
        document.getElementById("status-salvar").innerText = "⚠️ Por favor, preencha todos os campos obrigatórios.";
        return;
      }

      // Enviando os dados para o banco de dados (tabela 'bioinsumos')
      const { error } = await supabase.from("bioinsumos").insert([dados]);

      if (error) {
        document.getElementById("status-salvar").innerText = "❌ Erro ao salvar: " + error.message;
        console.error(error);
      } else {
        document.getElementById("status-salvar").innerText = "✅ Bioinsumo cadastrado com sucesso!";
        document.getElementById("bioinsumo-form").reset(); // Limpa o formulário após o envio
      }
    });

    // Envio para Análise Laboratorial (Integração real com Supabase)
    document.getElementById("enviar-analise").addEventListener("click", async function() {
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      if (sessionError || !session) {
        document.getElementById("status-analise").innerText = "⚠️ Nenhuma sessão ativa. Faça login.";
        return;
      }

      const userId = session.user.id;

      // Garantir que `usuario_id` seja validado
      if (!userId) {
        document.getElementById("status-analise").innerText = "⚠️ Usuario não encontrado. Faça login novamente.";
        return;
      }

      const dadosAnalise = {
        usuario_id: userId,  // Garantindo que o `usuario_id` seja definido
        data_envio: new Date().toISOString()  // Usando a data atual
      };

      // Enviando os dados para a tabela 'analises' no Supabase
      const { error } = await supabase.from("analises").insert([dadosAnalise]);

      if (error) {
        document.getElementById("status-analise").innerText = "❌ Erro ao enviar para análise: " + error.message;
        console.error(error);
      } else {
        document.getElementById("status-analise").innerText = "✅ Amostra enviada para análise!";
      }
    });
  </script>
<script>

// MELHORIA 3: Campos dinâmicos conforme tipo de bioinsumo
document.getElementById("tipo-bioinsumo").addEventListener("input", function() {
  const tipo = this.value.toLowerCase();
  const camposDinamicos = document.getElementById("fields-dinamicos");
  camposDinamicos.innerHTML = "";

  if (tipo.includes("fertilizante")) {
    camposDinamicos.innerHTML += '<input type="text" placeholder="Composição do Fertilizante" class="w-full px-3 py-2 border rounded mt-2">';
    camposDinamicos.innerHTML += '<input type="text" placeholder="Nutrientes Ativos" class="w-full px-3 py-2 border rounded">';
  } else if (tipo.includes("fungicida")) {
    camposDinamicos.innerHTML += '<input type="text" placeholder="Organismo Alvo" class="w-full px-3 py-2 border rounded mt-2">';
  }
});

// MELHORIA 4: Geração automática de recomendação com base nos dados
document.getElementById("diagnostico").addEventListener("input", function() {
  const diagnostico = this.value.toLowerCase();
  const recomendacoes = document.getElementById("recomendacoes");
  if (diagnostico.includes("fungo") || diagnostico.includes("mofo")) {
    recomendacoes.value = "Recomendamos o uso de bioinsumo com ação fungicida e compostos bioativos.";
  } else if (diagnostico.includes("baixa fertilidade")) {
    recomendacoes.value = "Recomendamos biofertilizante com foco em fósforo e potássio.";
  } else {
    recomendacoes.value = "Com base nas condições da sua propriedade, recomendamos o uso de bioinsumos adequados às condições identificadas.";
  }
});

// MELHORIA 5: Histórico dos bioinsumos
async function carregarHistorico() {
  const { data: { session }, error: sessionError } = await supabase.auth.getSession();
  if (sessionError || !session) return;
  const userId = session.user.id;
  const { data, error: selectError } = await supabase
    .from("bioinsumos")
    .select("*")
    .eq("usuario_id", userId)
    .order("id", { ascending: false });

  const historicoDiv = document.getElementById("historico");
  if (selectError) {
    historicoDiv.innerText = "Erro ao carregar histórico.";
    return;
  }
  if (data.length === 0) {
    historicoDiv.innerText = "Nenhum bioinsumo cadastrado ainda.";
    return;
  }

  let html = "<table class='w-full text-sm table-auto border'><thead><tr><th class='border px-2'>Diagnóstico</th><th class='border px-2'>Tipo</th><th class='border px-2'>Volume</th></tr></thead><tbody>";
  data.forEach(item => {
    html += `<tr><td class='border px-2'>${item.diagnostico}</td><td class='border px-2'>${item.tipo_bioinsumo}</td><td class='border px-2'>${item.volume_residuo || ""}</td></tr>`;
  });
  html += "</tbody></table>";
  historicoDiv.innerHTML = html;
}
window.addEventListener("load", carregarHistorico);

// MELHORIA 6: Exportação dos dados como CSV
function exportarCSV() {
  const linhas = [["Diagnóstico", "Tipo", "Função", "Aplicação", "Tipo de Resíduo", "Volume", "Origem"]];
  document.querySelectorAll("#historico table tbody tr").forEach(tr => {
    const cols = Array.from(tr.children).map(td => td.innerText);
    linhas.push(cols);
  });
  const csvContent = linhas.map(e => e.join(",")).join("\n");
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.setAttribute("href", URL.createObjectURL(blob));
  link.setAttribute("download", "bioinsumos.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
document.getElementById("btn-exportar").addEventListener("click", exportarCSV);

// MELHORIA 7: Formulário detalhado ao enviar para análise
document.getElementById("enviar-analise").addEventListener("click", async function() {
  const detalhes = prompt("Descreva detalhes da amostra (ex: origem, tipo, coleta):");
  if (!detalhes) return;

  const { data: { session }, error: sessionError } = await supabase.auth.getSession();
  if (sessionError || !session) {
    document.getElementById("status-analise").innerText = "⚠️ Nenhuma sessão ativa. Faça login.";
    return;
  }
  const userId = session.user.id;
  const dadosAnalise = {
    usuario_id: userId,
    data_envio: new Date().toISOString(),
    detalhes: detalhes
  };
  const { error } = await supabase.from("analises").insert([dadosAnalise]);
  if (error) {
    document.getElementById("status-analise").innerText = "❌ Erro ao enviar para análise: " + error.message;
  } else {
    document.getElementById("status-analise").innerText = "✅ Amostra enviada com sucesso!";
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/chart.js"></script><script>
// FILTRO (1)
async function aplicarFiltros() {
  const tipo = document.getElementById("filtro-tipo").value.toLowerCase();
  const diagnostico = document.getElementById("filtro-diagnostico").value.toLowerCase();
  const periodo = document.getElementById("filtro-periodo").value;

  const { data: { session } } = await supabase.auth.getSession();
  const userId = session.user.id;

  let query = supabase.from("bioinsumos").select("*").eq("usuario_id", userId);
  if (tipo) query = query.ilike("tipo_bioinsumo", `%{tipo}%`);
  if (diagnostico) query = query.ilike("diagnostico", `%{diagnostico}%`);
  if (periodo) query = query.gte("created_at", periodo);

  const { data, error } = await query;
  const historicoDiv = document.getElementById("historico");
  if (error || !data.length) {
    historicoDiv.innerHTML = "⚠️ Nenhum dado encontrado com os filtros aplicados.";
    return;
  }

  let html = "<table class='w-full text-sm table-auto border'><thead><tr><th class='border px-2'>Diagnóstico</th><th class='border px-2'>Tipo</th><th class='border px-2'>Volume</th></tr></thead><tbody>";
  data.forEach(item => {
    html += `<tr><td class='border px-2'>${item.diagnostico}</td><td class='border px-2'>${item.tipo_bioinsumo}</td><td class='border px-2'>${item.volume_residuo || ""}</td></tr>`;
  });
  html += "</tbody></table>";
  historicoDiv.innerHTML = html;
  plotarGrafico(data);
}

// GRÁFICO (2)
function plotarGrafico(data) {
  const ctx = document.getElementById("graficoVolume").getContext("2d");
  const tipos = [...new Set(data.map(item => item.tipo_bioinsumo))];
  const volumes = tipos.map(tipo => data
    .filter(d => d.tipo_bioinsumo === tipo)
    .reduce((soma, d) => soma + (d.volume_residuo || 0), 0));

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: tipos,
      datasets: [{
        label: 'Volume Total (kg ou L)',
        data: volumes,
        backgroundColor: 'rgba(34, 197, 94, 0.7)'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      }
    }
  });
}


async function verificarNotificacoes() {
  const { data: { session }, error: sessionError } = await supabase.auth.getSession();
  if (sessionError || !session) return;
  const userId = session.user.id;
  const { data, error } = await supabase
    .from("analises")
    .select("*")
    .eq("usuario_id", userId)
    .order("data_envio", { ascending: false })
    .limit(1);
  if (data && data[0] && data[0].status === "concluída") {
    alert("✅ Sua análise está pronta! Verifique os resultados no painel.");
  }
}
window.addEventListener("load", verificarNotificacoes);

</script></body>
</html>
